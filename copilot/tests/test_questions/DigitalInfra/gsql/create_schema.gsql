USE GRAPH DigitalInfra

CREATE SCHEMA_CHANGE JOB create_digital_infra_graph {
    ADD VERTEX Microservice(PRIMARY_ID id STRING) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX Container(PRIMARY_ID id STRING) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX BareMetalNode(PRIMARY_ID id STRING) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX NodeMetric(PRIMARY_ID id STRING, time_read DATETIME, mem_util DOUBLE, cpu_util DOUBLE) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX ContainerMetric(PRIMARY_ID id STRING, time_read DATETIME, mem_util DOUBLE, cpu_util DOUBLE) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD DIRECTED EDGE RUNS_IN(FROM Microservice, TO Container) WITH REVERSE_EDGE="reverse_RUNS_IN";
    ADD DIRECTED EDGE DEPLOYED_ON(FROM Container, TO BareMetalNode) WITH REVERSE_EDGE="reverse_DEPLOYED_ON";
    ADD DIRECTED EDGE HAS_UTILIZATION(FROM Container, TO ContainerMetric|FROM BareMetalNode, TO NodeMetric) WITH REVERSE_EDGE="reverse_HAS_UTILIZATION";
    ADD VERTEX UserService(PRIMARY_ID id STRING) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX Trace(PRIMARY_ID id STRING) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD VERTEX MSCall(PRIMARY_ID id STRING, timestamp DATETIME, rpc_id STRING, response_time FLOAT) WITH STATS="OUTDEGREE_BY_EDGETYPE", PRIMARY_ID_AS_ATTRIBUTE="true";
    ADD DIRECTED EDGE HAS(FROM UserService, TO Trace) WITH REVERSE_EDGE="reverse_HAS";
    ADD DIRECTED EDGE IN_TRACE(FROM MSCall, TO Trace) WITH REVERSE_EDGE="reverse_IN_TRACE";
    ADD DIRECTED EDGE MAKES_CALL(FROM Container, TO MSCall);
    ADD DIRECTED EDGE RECEIVES_CALL(FROM MSCall, TO Container);
    ADD DIRECTED EDGE CALLS(FROM Microservice, TO Microservice) WITH REVERSE_EDGE="reverse_CALLS";
    ADD DIRECTED EDGE HAS_CHILD_CALL(FROM MSCall, TO MSCall) WITH REVERSE_EDGE="reverse_HAS_CHILD_CALL";
}

RUN SCHEMA_CHANGE JOB create_digital_infra_graph